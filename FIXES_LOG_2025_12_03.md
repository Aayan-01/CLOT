# Error Fixes - December 3, 2025

## Issues Fixed

### 1. Firestore NOT_FOUND Error (Code 5)
**Error**: `Error: 5 NOT_FOUND` during `WriteBatch.commit()` in `ai_logs` collection

**Root Causes**:
- Missing or invalid `GOOGLE_APPLICATION_CREDENTIALS` environment variable
- Firestore database not properly initialized in Cloud Run
- Invalid Firestore instance reference

**Fixes Applied**:
- ✅ Added lazy initialization with null checks in `firestore.ts`
- ✅ Added validation for `sessionId` parameter (must be non-empty string)
- ✅ Enhanced error logging with gRPC error codes, details, and metadata
- ✅ Added helpful error message suggesting to check `GOOGLE_APPLICATION_CREDENTIALS`

**How to Fix**:
1. **In Cloud Run**: Ensure the service account has `Datastore User` and `Datastore Editor` roles
2. **In local development**: Set `GOOGLE_APPLICATION_CREDENTIALS` to your service account key JSON:
   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json
   ```
3. **Verify Firestore**: Check Cloud Console → Firestore → Databases to ensure database exists
4. Check server logs for detailed error messages now showing error code and metadata

---

### 2. GCS Bucket NOT_FOUND Error
**Error**: `GCS bucket does not exist: retro-rate`

**Root Causes**:
- `GCS_BUCKET_NAME` environment variable set to "retro-rate" but bucket doesn't exist
- Typo or misconfigured bucket name
- Bucket deleted or in different project

**Fixes Applied**:
- ✅ Enhanced error messages distinguishing between:
  - Bucket doesn't exist
  - Permission denied (403 error)
  - Configuration missing
- ✅ Added actionable guidance in error messages
- ✅ Improved route handler logging with clear fix instructions
- ✅ Added helpful information comments in warnings

**How to Fix**:

**Option A: Create the missing bucket** (recommended for Cloud Run)
```bash
gsutil mb gs://retro-rate
# Set lifecycle rules if needed
gsutil lifecycle set - gs://retro-rate <<EOF
{
  "lifecycle": {
    "rule": [
      {
        "action": {"type": "Delete"},
        "condition": {"age": 30}  # Delete files older than 30 days
      }
    ]
  }
}
EOF
```

**Option B: Use different bucket** (if retro-rate can't be used)
```bash
# List available buckets
gsutil ls

# Deploy with existing bucket
gcloud run deploy retro-rate \
  --set-env-vars GCS_BUCKET_NAME=your-existing-bucket \
  ...
```

**Option C: Disable GCS uploads** (development only)
```bash
# Unset the variable so the system uses local file storage
unset GCS_BUCKET_NAME
```

**Verify Configuration**:
- Check Cloud Run environment variables in Cloud Console
- Verify service account has `Storage Object Creator` and `Storage Object Viewer` roles
- Test bucket access:
  ```bash
  gsutil ls gs://retro-rate
  ```

---

## Files Modified

1. **`server/src/services/firestore.ts`**
   - Added lazy initialization pattern
   - Added null checks and validation
   - Enhanced error logging with gRPC details

2. **`server/src/services/gcs.ts`**
   - Improved bucket validation error messages
   - Added permission error detection
   - Better error diagnostics

3. **`server/src/routes/upload.ts`**
   - Enhanced GCS error logging
   - Added helpful fix suggestions in console warnings

---

## Environment Variables Required

For Cloud Run deployment, ensure these are set in Secret Manager or as environment variables:

```
GOOGLE_CLOUD_GEMINI_API_KEY       # Gemini API key for AI analysis
GCS_BUCKET_NAME                   # GCS bucket (e.g., "retro-rate")
GCS_MAKE_PUBLIC                   # Make uploads public: "true" or "false"
GOOGLE_APPLICATION_CREDENTIALS    # Path to service account key (local dev only)
```

---

## Testing the Fixes

After deployment, the logs will now show:

**Before fix (vague):**
```
❌ Analysis error: Error: 5 NOT_FOUND
GCS upload failed, continuing — check configuration GCS bucket does not exist: retro-rate
```

**After fix (actionable):**
```
GCS check failed for bucket "retro-rate": GCS bucket "retro-rate" does not exist. 
Create it in Cloud Storage or set GCS_BUCKET_NAME to an existing bucket.

⚠️ GCS upload failed, continuing without cloud storage. Error: [detailed error]
ℹ️ To fix: ensure GCS_BUCKET_NAME env var points to an existing bucket 
   and service account has permissions.
```

---

## Next Steps

1. **For local development**: Set `GOOGLE_APPLICATION_CREDENTIALS` and test locally
2. **For Cloud Run**: 
   - Create the GCS bucket or update `GCS_BUCKET_NAME`
   - Update service account permissions
   - Redeploy or update environment variables
3. **Verify**: Re-run analysis and check logs for the new detailed error messages

